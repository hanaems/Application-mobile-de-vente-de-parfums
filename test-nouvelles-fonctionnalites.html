<!DOCTYPE html>
<html>
<head>
    <title>Test Nouvelles Fonctionnalit√©s</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .section { margin: 30px 0; padding: 20px; border: 1px solid #ddd; border-radius: 8px; }
        .success { color: green; }
        .error { color: red; }
        .info { color: blue; }
        button { margin: 5px; padding: 10px 15px; cursor: pointer; }
        .test-result { margin: 10px 0; padding: 10px; background: #f9f9f9; border-radius: 4px; }
    </style>
</head>
<body>
    <h1>üß™ Test des Nouvelles Fonctionnalit√©s</h1>
    
    <div class="section">
        <h2>üóëÔ∏è Test Annulation de Commandes</h2>
        <p class="info">Test de l'API d'annulation de commandes c√¥t√© utilisateur</p>
        
        <div>
            <h3>Commandes disponibles pour test :</h3>
            <div id="commandes-test">Chargement...</div>
        </div>
        
        <div>
            <h3>Tests d'annulation :</h3>
            <button onclick="testCancelOrder(4, 7, 'confirmee')">Tester annulation commande #4 (confirm√©e)</button>
            <button onclick="testCancelOrder(6, 7, 'en_cours')">Tester annulation commande #6 (en cours - doit √©chouer)</button>
            <div id="cancel-results"></div>
        </div>
    </div>
    
    <div class="section">
        <h2>üîç Test Filtrage des Commandes Admin</h2>
        <p class="info">Test des filtres par date et statut</p>
        
        <div>
            <button onclick="testFilter('statut', 'confirmee')">Filtrer par statut "confirm√©e"</button>
            <button onclick="testFilter('statut', 'en_cours')">Filtrer par statut "en cours"</button>
            <button onclick="testFilter('date', '2025-12-13')">Filtrer par date du 13/12/2025</button>
            <button onclick="testFilter('dateRange', '2025-12-12,2025-12-13')">Filtrer par plage de dates</button>
            <div id="filter-results"></div>
        </div>
    </div>
    
    <div class="section">
        <h2>üìä R√©sum√© des Tests</h2>
        <div id="test-summary">
            <p>Lancez les tests ci-dessus pour voir les r√©sultats</p>
        </div>
    </div>
    
    <script>
        const API_URL = 'http://192.168.11.105:3000/api';
        let testResults = [];
        
        // Charger les commandes pour les tests
        async function loadCommandesForTest() {
            try {
                const response = await fetch(`${API_URL}/admin/orders`);
                const orders = await response.json();
                
                const container = document.getElementById('commandes-test');
                container.innerHTML = orders.slice(0, 5).map(order => `
                    <div class="test-result">
                        <strong>Commande #${order.id}</strong> - 
                        Statut: ${order.statut} - 
                        Client: ${order.nom} - 
                        Date: ${new Date(order.date_commande).toLocaleDateString('fr-FR')}
                    </div>
                `).join('');
                
                addTestResult('‚úÖ Chargement des commandes', 'success');
            } catch (error) {
                document.getElementById('commandes-test').innerHTML = `<p class="error">Erreur: ${error.message}</p>`;
                addTestResult('‚ùå Erreur chargement commandes', 'error');
            }
        }
        
        // Test d'annulation de commande
        async function testCancelOrder(commandeId, userId, expectedStatut) {
            try {
                const response = await fetch(`${API_URL}/commandes/${userId}/${commandeId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                const container = document.getElementById('cancel-results');
                
                if (result.success) {
                    container.innerHTML += `<div class="test-result success">‚úÖ Commande #${commandeId} annul√©e avec succ√®s</div>`;
                    addTestResult(`Annulation commande #${commandeId}`, 'success');
                } else {
                    container.innerHTML += `<div class="test-result error">‚ùå √âchec annulation #${commandeId}: ${result.message}</div>`;
                    addTestResult(`√âchec annulation #${commandeId} (attendu si statut != confirm√©e)`, 'info');
                }
            } catch (error) {
                const container = document.getElementById('cancel-results');
                container.innerHTML += `<div class="test-result error">‚ùå Erreur annulation #${commandeId}: ${error.message}</div>`;
                addTestResult(`Erreur annulation #${commandeId}`, 'error');
            }
        }
        
        // Test de filtrage
        async function testFilter(type, value) {
            try {
                let url = `${API_URL}/admin/orders`;
                let params = new URLSearchParams();
                let description = '';
                
                switch(type) {
                    case 'statut':
                        params.append('statut', value);
                        description = `Filtre par statut: ${value}`;
                        break;
                    case 'date':
                        params.append('dateFrom', value);
                        description = `Filtre par date √† partir du: ${value}`;
                        break;
                    case 'dateRange':
                        const [dateFrom, dateTo] = value.split(',');
                        params.append('dateFrom', dateFrom);
                        params.append('dateTo', dateTo);
                        description = `Filtre par plage: ${dateFrom} √† ${dateTo}`;
                        break;
                }
                
                if (params.toString()) {
                    url += '?' + params.toString();
                }
                
                const response = await fetch(url);
                const orders = await response.json();
                
                const container = document.getElementById('filter-results');
                container.innerHTML += `
                    <div class="test-result success">
                        <strong>‚úÖ ${description}</strong><br>
                        R√©sultats: ${orders.length} commande(s) trouv√©e(s)<br>
                        URL: ${url}
                    </div>
                `;
                
                addTestResult(`Filtrage: ${description}`, 'success');
                
            } catch (error) {
                const container = document.getElementById('filter-results');
                container.innerHTML += `<div class="test-result error">‚ùå Erreur filtrage: ${error.message}</div>`;
                addTestResult(`Erreur filtrage ${type}`, 'error');
            }
        }
        
        // Ajouter un r√©sultat de test
        function addTestResult(test, status) {
            testResults.push({ test, status, time: new Date().toLocaleTimeString() });
            updateSummary();
        }
        
        // Mettre √† jour le r√©sum√©
        function updateSummary() {
            const summary = document.getElementById('test-summary');
            const successCount = testResults.filter(r => r.status === 'success').length;
            const errorCount = testResults.filter(r => r.status === 'error').length;
            const infoCount = testResults.filter(r => r.status === 'info').length;
            
            summary.innerHTML = `
                <h3>R√©sultats des Tests</h3>
                <p><span class="success">‚úÖ Succ√®s: ${successCount}</span></p>
                <p><span class="error">‚ùå Erreurs: ${errorCount}</span></p>
                <p><span class="info">‚ÑπÔ∏è Info: ${infoCount}</span></p>
                <h4>D√©tail:</h4>
                ${testResults.map(r => `
                    <div class="${r.status}">${r.time} - ${r.test}</div>
                `).join('')}
            `;
        }
        
        // Charger les commandes au d√©marrage
        loadCommandesForTest();
    </script>
</body>
</html>